name: HFS Continuous Delivery

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to deploy (e.g., v0.1.8)'
        required: true
        type: string

jobs:
  deploy:
    name: Deploy to server
    runs-on: [self-hosted, Linux] 
    
    steps:
    - name: Download release binary
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          // Determine the tag based on trigger type
          const tag = context.eventName === 'workflow_dispatch' 
            ? '${{ inputs.tag }}' 
            : context.ref.replace('refs/tags/', '');
          
          const { data: release } = await github.rest.repos.getReleaseByTag({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag: tag
          });
          
          // Find the Linux binary (using Rust target triple naming)
          const asset = release.assets.find(asset => 
            asset.name.includes('x86_64-unknown-linux-gnu') && 
            asset.name.endsWith('.tar.gz')
          );
          
          if (!asset) {
            throw new Error('Linux binary (x86_64-unknown-linux-gnu.tar.gz) not found in release assets');
          }
          
          const { data } = await github.rest.repos.getReleaseAsset({
            owner: context.repo.owner,
            repo: context.repo.repo,
            asset_id: asset.id,
            headers: {
              Accept: 'application/octet-stream'
            }
          });
          
          fs.writeFileSync('release-binary.tar.gz', Buffer.from(data));
          console.log(`Downloaded: ${asset.name}`);

    - name: Extract binary
      run: |
        tar -xzf release-binary.tar.gz
        chmod +x fhirpath-server
        
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          # Create deployment directory
          sudo mkdir -p /opt/fhirpath-server
          
          # Stop existing service (if running)
          sudo systemctl stop fhirpath-server || true
          
          # Backup current version
          sudo cp /opt/fhirpath-server/fhirpath-server \
             /opt/fhirpath-server/fhirpath-server.backup || true

    - name: Upload new binary
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        source: fhirpath-server
        target: /tmp/

    - name: Install and start service
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          # Move binary to final location
          sudo mv /tmp/fhirpath-server /opt/fhirpath-server/
          sudo chown root:root /opt/fhirpath-server/fhirpath-server
          sudo chmod +x /opt/fhirpath-server/fhirpath-server
          
          # Create systemd service file if it doesn't exist
          if [ ! -f /etc/systemd/system/fhirpath-server.service ]; then
            sudo tee /etc/systemd/system/fhirpath-server.service > /dev/null <<EOF
          [Unit]
          Description=FHIRPath Server
          After=network.target
          
          [Service]
          Type=simple
          User=nobody
          Group=nogroup
          ExecStart=/opt/fhirpath-server/fhirpath-server
          Restart=always
          RestartSec=5
          Environment="RUST_MIN_STACK=8388608"
          
          [Install]
          WantedBy=multi-user.target
          EOF
            sudo systemctl daemon-reload
            sudo systemctl enable fhirpath-server
          fi
          
          # Start the service
          sudo systemctl start fhirpath-server
          sudo systemctl status fhirpath-server

    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          # Wait a moment for service to start
          sleep 5
          
          # Check if service is running
          if sudo systemctl is-active --quiet fhirpath-server; then
            echo "✅ Deployment successful - service is running"
            sudo systemctl status fhirpath-server
          else
            echo "❌ Deployment failed - service is not running"
            sudo journalctl -u fhirpath-server --lines=20
            exit 1
          fi
