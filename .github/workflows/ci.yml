name: HFS Continuous Integration

on:
  push:
    branches: [main, develop]
    tags:
      - 'v*'
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_MIN_STACK: 8388608
  CARGO_BUILD_JOBS: 1

jobs:
  test:
    name: Test Suite
    runs-on: [self-hosted, Linux]
    strategy:
      matrix:
        rust: [stable, beta, nightly]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - name: Configure Rust to use LLD
        run: |
          mkdir -p ~/.cargo
          if ! grep -q "link-arg=-fuse-ld=lld" ~/.cargo/config.toml 2>/dev/null; then
            echo "[target.x86_64-unknown-linux-gnu]" >> ~/.cargo/config.toml
            echo 'linker = "clang"' >> ~/.cargo/config.toml
            echo 'rustflags = ["-C", "link-arg=-fuse-ld=lld"]' >> ~/.cargo/config.toml
          fi

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # R6 is currently broken - issue with TestScript
      #    - name: Build the FHIR model code generator for all versions (This will download the latest R6 from https://build.fhir.org/
      #run: |
      #echo "Build the FHIR model code generator for all versions..."
      #cargo build -p helios-fhir-gen --all-features

      #- name: Generate all FHIR model code
      #run: |
      #echo "Generate all FHIR model code..."
      #./target/debug/helios-fhir-gen --all

      - name: Run tests with all features
        run: |
          echo "Running tests with all features..."
          #cargo test --all-features 
          cargo test --features R4,R4B,R5

  lint:
    name: Linting
    runs-on: [self-hosted, Linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: |
          cargo clippy --all-targets --features R4,R4B,R5 -- -D warnings -A clippy::items_after_test_module -A clippy::large_enum_variant -A clippy::question_mark -A clippy::collapsible_match -A clippy::collapsible_if -A clippy::field_reassign_with_default -A clippy::doc-overindented-list-items

  security:
    name: Security Audit
    runs-on: [self-hosted, Linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

  coverage:
    name: Code Coverage
    runs-on: [self-hosted, Linux]
    needs: [test, lint, security]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: llvm-tools-preview

      - name: Configure Rust to use LLD
        run: |
          mkdir -p ~/.cargo
          if ! grep -q "link-arg=-fuse-ld=lld" ~/.cargo/config.toml 2>/dev/null; then
            echo "[target.x86_64-unknown-linux-gnu]" >> ~/.cargo/config.toml
            echo 'linker = "clang"' >> ~/.cargo/config.toml
            echo 'rustflags = ["-C", "link-arg=-fuse-ld=lld"]' >> ~/.cargo/config.toml
          fi

      # Needed to pre-install this on the agent using: cargo install cargo-llvm-cov
      #- name: Install cargo-llvm-cov
      #  uses: taiki-e/install-action@cargo-llvm-cov

      - name: Generate code coverage
        run: cargo llvm-cov --workspace --lcov --output-path lcov.info

      # Upload to Codecov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}

  fhirpath-validation:
    name: FhirPath Validation
    runs-on: [self-hosted, Windows]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for change detection

      - name: Download FhirPath Validator
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            console.log('Fetching latest FhirPath Validator release...');

            const { data: release } = await github.rest.repos.getLatestRelease({
              owner: 'HeliosSoftware',
              repo: 'Hl7.Fhir.FhirPath.Validator'
            });

            console.log(`Latest FhirPath Validator release: ${release.tag_name}`);

            // Find the Windows executable archive
            const asset = release.assets.find(asset => 
              asset.name.includes('win-x64') && asset.name.endsWith('.zip')
            );

            if (!asset) {
              console.log('Available assets:', release.assets.map(a => a.name));
              throw new Error('Windows FhirPath validator archive not found');
            }

            console.log(`Downloading FhirPath Validator: ${asset.name}`);

            const { data } = await github.rest.repos.getReleaseAsset({
              owner: 'HeliosSoftware',
              repo: 'Hl7.Fhir.FhirPath.Validator',
              asset_id: asset.id,
              headers: {
                Accept: 'application/octet-stream'
              }
            });

            fs.writeFileSync('fhirpath-validator.zip', Buffer.from(data));
            console.log('FhirPath Validator download completed');

      - name: Download FHIR Test Cases
        run: |
          echo "Downloading FHIR R5 test cases..."
          curl -L -o tests-fhir-r5.xml "https://raw.githubusercontent.com/FHIR/fhir-test-cases/master/r5/fhirpath/tests-fhir-r5.xml"

          if not exist "tests-fhir-r5.xml" (
            echo "Failed to download FHIR test cases"
            exit /b 1
          )

          echo "FHIR test cases downloaded successfully"
          dir tests-fhir-r5.xml

      - name: Extract and Setup FhirPath Validator
        shell: powershell
        run: |
          # Extract the validator
          New-Item -ItemType Directory -Force -Path "tools/fhirpath-validator"
          Expand-Archive -Path "fhirpath-validator.zip" -DestinationPath "tools/fhirpath-validator" -Force

          # Find the executable (it should be Test.Fhir.R5.FhirPath.Validator.exe)
          $validatorPath = Get-ChildItem -Path "tools/fhirpath-validator" -Recurse -Name "Test.Fhir.R5.FhirPath.Validator.exe" | Select-Object -First 1

          if ($validatorPath) {
            $fullValidatorPath = Join-Path "tools/fhirpath-validator" $validatorPath
            Write-Host "Found validator at: $fullValidatorPath"
            
            # Copy to root for easier access
            Copy-Item $fullValidatorPath "fhirpath-validator.exe"
            
            # Verify it works
            try {
              & ".\fhirpath-validator.exe" --help
            } catch {
              Write-Host "Validator help not available, but binary extracted"
            }
          } else {
            Write-Host "Validator executable not found"
            Get-ChildItem -Path "tools/fhirpath-validator" -Recurse
          }

      - name: Run FhirPath Validation with FHIR Test Cases
        shell: powershell
        run: |
          Write-Host "Running FhirPath validation with FHIR R5 test cases..."

          # Run the validator with the downloaded test cases
          # According to the documentation, use --fhir-test-file CLI argument
          $testFilePath = Resolve-Path "tests-fhir-r5.xml"
          & ".\fhirpath-validator.exe" --fhir-test-file "$testFilePath"

          $VALIDATOR_EXIT_CODE = $LASTEXITCODE

          if ($VALIDATOR_EXIT_CODE -eq 0) {
            Write-Host " All FhirPath validation tests passed"
          } elseif ($VALIDATOR_EXIT_CODE -eq 1) {
            Write-Host " Some FhirPath validation tests failed"
            exit 1
          } elseif ($VALIDATOR_EXIT_CODE -eq 2) {
            Write-Host " Fatal error occurred during FhirPath validation"
            exit 1
          } else {
            Write-Host " Unexpected exit code: $VALIDATOR_EXIT_CODE"
            exit 1
          }

      # - name: Upload Test Results
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: fhirpath-test-results
      #     path: |
      #       tests-fhir-r5.xml
      #       *.log
      #     retention-days: 7

  build:
    name: Build Release
    runs-on: ${{ matrix.os }}
    needs: [test, lint, security]
    if: startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix:
        include:
          - os: Linux
            runner: [self-hosted, Linux]
            target: x86_64-unknown-linux-gnu
            archive_ext: tar.gz
          - os: Windows
            runner: [self-hosted, Windows]
            target: x86_64-pc-windows-msvc
            archive_ext: zip
        #      - os: macOS
        #        runner: [self-hosted, macOS, aarch64]
        #        target: aarch64-apple-darwin
        #        archive_ext: tar.gz
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      # TODO - need to add all of the target types
      - name: Configure Rust to use LLD
        run: |
          mkdir -p ~/.cargo
          if ! grep -q "link-arg=-fuse-ld=lld" ~/.cargo/config.toml 2>/dev/null; then
            echo "[target.x86_64-unknown-linux-gnu]" >> ~/.cargo/config.toml
            echo 'linker = "clang"' >> ~/.cargo/config.toml
            echo 'rustflags = ["-C", "link-arg=-fuse-ld=lld"]' >> ~/.cargo/config.toml
          fi

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --features R4,R4B,R5 --release

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hfs-${{ matrix.target }}
          path: |
            target/release/
            !target/release/build/
            !target/release/deps/
            !target/release/incremental/
            !target/release/*.d
            !target/release/*.rlib
            !target/release/*.so

  release:
    name: Create GitHub Release
    runs-on: [self-hosted, Linux]
    needs: [build]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create release archives
        run: |
          mkdir -p releases
          # Extract version from tag (remove 'v' prefix)
          version="${{ github.ref_name }}"
          version="${version#v}"

          cd artifacts
          for dir in */; do
            # Extract target from directory name (format: hfs-{target}/)
            if [[ "$dir" =~ hfs-(.+)/ ]]; then
              target="${BASH_REMATCH[1]}"
              
              # Create combined archive with version in filename
              if [[ "$target" == *"windows"* ]]; then
                cd "$dir" && zip -r ../../releases/hfs-${version}-${target}.zip . && cd ..
              else
                tar -czf ../releases/hfs-${version}-${target}.tar.gz -C "$dir" .
              fi
            fi
          done

      - name: Generate changelog
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            # Extract changelog for this version
            sed -n "/^## \[$(echo ${{ github.ref_name }} | sed 's/v//')\]/,/^## \[/p" CHANGELOG.md | head -n -1 > current_changelog.md
            echo "changelog_exists=true" >> $GITHUB_OUTPUT
          else
            echo "## What's Changed" > current_changelog.md
            echo "changelog_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: releases/*
          body_path: current_changelog.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: ${{ steps.changelog.outputs.changelog_exists == 'false' }}
