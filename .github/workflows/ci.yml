name: HFS Continuous Integration

on:
  push:
    branches: [main, develop]
    tags:
      - 'v*'
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_MIN_STACK: 8388608
  CARGO_BUILD_JOBS: 1

jobs:
  test:
    name: Test Suite
    runs-on: [self-hosted, Linux]
    strategy:
      matrix:
        rust: [stable, beta, nightly]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - name: Configure Rust to use LLD
        run: |
          mkdir -p ~/.cargo
          if ! grep -q "link-arg=-fuse-ld=lld" ~/.cargo/config.toml 2>/dev/null; then
            echo "[target.x86_64-unknown-linux-gnu]" >> ~/.cargo/config.toml
            echo 'linker = "clang"' >> ~/.cargo/config.toml
            echo 'rustflags = ["-C", "link-arg=-fuse-ld=lld"]' >> ~/.cargo/config.toml
          fi

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # R6 is currently broken - issue with TestScript
      #    - name: Build the FHIR model code generator for all versions (This will download the latest R6 from https://build.fhir.org/
      #run: |
      #echo "Build the FHIR model code generator for all versions..."
      #cargo build -p helios-fhir-gen --all-features

      #- name: Generate all FHIR model code
      #run: |
      #echo "Generate all FHIR model code..."
      #./target/debug/helios-fhir-gen --all

      - name: Run tests with all features
        run: |
          echo "Running tests with all features..."
          #cargo test --all-features 
          cargo test --features R4,R4B,R5

  lint:
    name: Linting
    runs-on: [self-hosted, Linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: |
          cargo clippy --all-targets --features R4,R4B,R5 -- -D warnings -A clippy::items_after_test_module -A clippy::large_enum_variant -A clippy::question_mark -A clippy::collapsible_match -A clippy::collapsible_if -A clippy::field_reassign_with_default -A clippy::doc-overindented-list-items

  security:
    name: Security Audit
    runs-on: [self-hosted, Linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

  coverage:
    name: Code Coverage
    runs-on: [self-hosted, Linux]
    needs: [test, lint, security]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: llvm-tools-preview

      - name: Configure Rust to use LLD
        run: |
          mkdir -p ~/.cargo
          if ! grep -q "link-arg=-fuse-ld=lld" ~/.cargo/config.toml 2>/dev/null; then
            echo "[target.x86_64-unknown-linux-gnu]" >> ~/.cargo/config.toml
            echo 'linker = "clang"' >> ~/.cargo/config.toml
            echo 'rustflags = ["-C", "link-arg=-fuse-ld=lld"]' >> ~/.cargo/config.toml
          fi

      # Needed to pre-install this on the agent using: cargo install cargo-llvm-cov
      #- name: Install cargo-llvm-cov
      #  uses: taiki-e/install-action@cargo-llvm-cov

      - name: Generate code coverage
        run: cargo llvm-cov --workspace --lcov --output-path lcov.info

      # Upload to Codecov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}

  fhirpath-validation:
    name: FhirPath Validation
    runs-on: [self-hosted, Windows]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for change detection

      - name: Download FhirPath Validator
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            console.log('Fetching latest FhirPath Validator release...');

            const { data: release } = await github.rest.repos.getLatestRelease({
              owner: 'HeliosSoftware',
              repo: 'Hl7.Fhir.FhirPath.Validator'
            });

            console.log(`Latest FhirPath Validator release: ${release.tag_name}`);

            // Find the Windows executable archive
            const asset = release.assets.find(asset => 
              asset.name.includes('win-x64') && asset.name.endsWith('.zip')
            );

            if (!asset) {
              console.log('Available assets:', release.assets.map(a => a.name));
              throw new Error('Windows FhirPath validator archive not found');
            }

            console.log(`Downloading FhirPath Validator: ${asset.name}`);

            const { data } = await github.rest.repos.getReleaseAsset({
              owner: 'HeliosSoftware',
              repo: 'Hl7.Fhir.FhirPath.Validator',
              asset_id: asset.id,
              headers: {
                Accept: 'application/octet-stream'
              }
            });

            fs.writeFileSync('fhirpath-validator.zip', Buffer.from(data));
            console.log('FhirPath Validator download completed');

      - name: Download FHIR Test Cases
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const https = require('https');

            console.log('Downloading FHIR R5 test cases...');

            const url = 'https://raw.githubusercontent.com/FHIR/fhir-test-cases/master/r5/fhirpath/tests-fhir-r5.xml';
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error(`Failed to download FHIR test cases: ${response.status} ${response.statusText}`);
            }
            const data = await response.text();
            fs.writeFileSync('tests-fhir-r5.xml', data, 'utf8');
            console.log('FHIR test cases downloaded successfully');
            console.log(`File size: ${fs.statSync('tests-fhir-r5.xml').size} bytes`);

      - name: Extract and Setup FhirPath Validator
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');

            console.log('Extracting FhirPath Validator...');

            // Create directory
            const toolsDir = 'tools/fhirpath-validator';
            fs.mkdirSync(toolsDir, { recursive: true });

            // Extract using tar (available on Windows 10+)
            try {
              execSync(`tar -xf fhirpath-validator.zip -C ${toolsDir}`, { stdio: 'inherit' });
            } catch (error) {
              console.error('Failed to extract with tar, trying alternative method...');
              throw error;
            }

            // Find the executable recursively
            function findFile(dir, filename) {
              const files = fs.readdirSync(dir);
              for (const file of files) {
                const fullPath = path.join(dir, file);
                const stat = fs.statSync(fullPath);
                if (stat.isDirectory()) {
                  const found = findFile(fullPath, filename);
                  if (found) return found;
                } else if (file === filename) {
                  return fullPath;
                }
              }
              return null;
            }

            const validatorPath = findFile(toolsDir, 'Test.Fhir.R5.FhirPath.Validator.exe');

            if (validatorPath) {
              console.log(`Found validator at: ${validatorPath}`);
              
              // Copy to root for easier access
              fs.copyFileSync(validatorPath, 'fhirpath-validator.exe');
              console.log('Validator setup complete');
              
              // Verify it works
              try {
                execSync('.\\fhirpath-validator.exe --help', { stdio: 'pipe' });
                console.log('Validator help command successful');
              } catch (error) {
                console.log('Validator help not available, but binary extracted');
              }
            } else {
              console.log('Validator executable not found');
              console.log('Directory contents:');
              execSync(`dir /s ${toolsDir}`, { stdio: 'inherit' });
              throw new Error('Validator executable not found');
            }

      - name: Run FhirPath Validation with FHIR Test Cases
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const path = require('path');

            console.log('Running FhirPath validation with FHIR R5 test cases...');

            // Get absolute paths
            const testFilePath = path.resolve('tests-fhir-r5.xml');
            const knownFailuresPath = path.resolve('crates/fhirpath/tests/data/r5/known-test-failures.json');
            
            console.log(`Test file path: ${testFilePath}`);
            console.log(`Known failures file: ${knownFailuresPath}`);

            try {
              // Run the validator as a console application with CLI arguments
              const command = `fhirpath-validator.exe --fhir-test-file "${testFilePath}" --known-failures "${knownFailuresPath}"`;
              console.log(`Executing: ${command}`);
              
              const result = execSync(command, { 
                stdio: 'inherit',
                encoding: 'utf8'
              });
              
              console.log('âœ… All FhirPath validation tests passed (excluding known failures)');
            } catch (error) {
              const exitCode = error.status;
              
              if (exitCode === 1) {
                console.log('âŒ Some FhirPath validation tests failed');
                process.exit(1);
              } else if (exitCode === 2) {
                console.log('ðŸ’¥ Fatal error occurred during FhirPath validation');
                process.exit(1);
              } else {
                console.log(`âš ï¸ Unexpected exit code: ${exitCode}`);
                process.exit(1);
              }
            }

      # - name: Upload Test Results
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: fhirpath-test-results
      #     path: |
      #       tests-fhir-r5.xml
      #       *.log
      #     retention-days: 7

  build:
    name: Build Release
    runs-on: ${{ matrix.os }}
    needs: [test, lint, security]
    if: startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix:
        include:
          - os: Linux
            runner: [self-hosted, Linux]
            target: x86_64-unknown-linux-gnu
            archive_ext: tar.gz
          - os: Windows
            runner: [self-hosted, Windows]
            target: x86_64-pc-windows-msvc
            archive_ext: zip
        #      - os: macOS
        #        runner: [self-hosted, macOS, aarch64]
        #        target: aarch64-apple-darwin
        #        archive_ext: tar.gz
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      # TODO - need to add all of the target types
      - name: Configure Rust to use LLD
        run: |
          mkdir -p ~/.cargo
          if ! grep -q "link-arg=-fuse-ld=lld" ~/.cargo/config.toml 2>/dev/null; then
            echo "[target.x86_64-unknown-linux-gnu]" >> ~/.cargo/config.toml
            echo 'linker = "clang"' >> ~/.cargo/config.toml
            echo 'rustflags = ["-C", "link-arg=-fuse-ld=lld"]' >> ~/.cargo/config.toml
          fi

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --features R4,R4B,R5 --release

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hfs-${{ matrix.target }}
          path: |
            target/release/
            !target/release/build/
            !target/release/deps/
            !target/release/incremental/
            !target/release/*.d
            !target/release/*.rlib
            !target/release/*.so

  release:
    name: Create GitHub Release
    runs-on: [self-hosted, Linux]
    needs: [build]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create release archives
        run: |
          mkdir -p releases
          # Extract version from tag (remove 'v' prefix)
          version="${{ github.ref_name }}"
          version="${version#v}"

          cd artifacts
          for dir in */; do
            # Extract target from directory name (format: hfs-{target}/)
            if [[ "$dir" =~ hfs-(.+)/ ]]; then
              target="${BASH_REMATCH[1]}"
              
              # Create combined archive with version in filename
              if [[ "$target" == *"windows"* ]]; then
                cd "$dir" && zip -r ../../releases/hfs-${version}-${target}.zip . && cd ..
              else
                tar -czf ../releases/hfs-${version}-${target}.tar.gz -C "$dir" .
              fi
            fi
          done

      - name: Generate changelog
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            # Extract changelog for this version
            sed -n "/^## \[$(echo ${{ github.ref_name }} | sed 's/v//')\]/,/^## \[/p" CHANGELOG.md | head -n -1 > current_changelog.md
            echo "changelog_exists=true" >> $GITHUB_OUTPUT
          else
            echo "## What's Changed" > current_changelog.md
            echo "changelog_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: releases/*
          body_path: current_changelog.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: ${{ steps.changelog.outputs.changelog_exists == 'false' }}
